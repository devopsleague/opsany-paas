#!/bin/bash
#******************************************
# Author:       Jason Zhao
# Email:        zhaoshundong@opsany.com
# Organization: OpsAny https://www.opsany.com/
# Description:  OpsAny SAAS Enterprise Edition Install Script
#******************************************

# Data/Time
CTIME=$(date "+%Y-%m-%d-%H-%M")

# Shell Envionment Variables
CDIR=$(pwd)
SHELL_NAME="saas-install.sh"
SHELL_LOG="${SHELL_NAME}.log"
ADMIN_PASSWORD=""

# Install Inspection
if [ ! -f ./install.config ];then
      echo "Please Change Directory to ${INSTALL_PATH}/install"
      exit
else
    grep '^[A-Z]' install.config > install.env
    source ./install.env && rm -f install.env
    if [ -z "$ADMIN_PASSWORD" ];then
        source ${INSTALL_PATH}/conf/.passwd_env
    fi
fi

rm -f ../saas/*.gz

# Shell Log Record
shell_log(){
    LOG_INFO=$1
    echo "----------------$CTIME ${SHELL_NAME} : ${LOG_INFO}----------------"
    echo "$CTIME ${SHELL_NAME} : ${LOG_INFO}" >> ${SHELL_LOG}
}

prom_update(){
    #prom
    cd $CDIR
    cd ../../opsany-saas-ee/
    /bin/cp prom-opsany-*.tar.gz ../opsany-paas/saas/
    cd $CDIR
    python3 ../saas/deploy.py --domain $DOMAIN_NAME --username admin --password $ADMIN_PASSWORD --file_name ../saas/prom-opsany-*.tar.gz
}

k8s_update(){
    #k8s
    cd $CDIR
    cd ../../opsany-saas-ee/
    /bin/cp k8s-opsany-*.tar.gz ../opsany-paas/saas/
    cd $CDIR
    python3 ../saas/deploy.py --domain $DOMAIN_NAME --username admin --password $ADMIN_PASSWORD --file_name ../saas/k8s-opsany-*.tar.gz
}
    
event_update(){
    #event
    cd $CDIR
    cd ../../opsany-saas-ee/
    /bin/cp event-opsany-*.tar.gz ../opsany-paas/saas/
    cd $CDIR
    python3 ../saas/deploy.py --domain $DOMAIN_NAME --username admin --password $ADMIN_PASSWORD --file_name ../saas/event-opsany-*.tar.gz
}

auto_update(){
    #auto
    cd $CDIR
    cd ../../opsany-saas-ee/
    /bin/cp auto-opsany-*.tar.gz ../opsany-paas/saas/
    cd $CDIR
    python3 ../saas/deploy.py --domain $DOMAIN_NAME --username admin --password $ADMIN_PASSWORD --file_name ../saas/auto-opsany-*.tar.gz
}

pipeline_update(){
    #pipeline
    cd $CDIR
    cd ../../opsany-saas-ee/
    /bin/cp pipeline-opsany-*.tar.gz ../opsany-paas/saas/
    cd $CDIR
    python3 ../saas/deploy.py --domain $DOMAIN_NAME --username admin --password $ADMIN_PASSWORD --file_name ../saas/pipeline-opsany-*.tar.gz
}

deploy_update(){
    #deploy
    cd $CDIR
    cd ../../opsany-saas-ee/
    /bin/cp deploy-opsany-*.tar.gz ../opsany-paas/saas/
    cd $CDIR
    python3 ../saas/deploy.py --domain $DOMAIN_NAME --username admin --password $ADMIN_PASSWORD --file_name ../saas/deploy-opsany-*.tar.gz
}

kbase_update(){
    #kbase
    cd $CDIR
    cd ../../opsany-saas-ee/
    /bin/cp kbase-opsany-*.tar.gz ../opsany-paas/saas/
    cd $CDIR
    python3 ../saas/deploy.py --domain $DOMAIN_NAME --username admin --password $ADMIN_PASSWORD --file_name ../saas/kbase-opsany-*.tar.gz
}

# Main
main(){
    case "$1" in
	prom)
		prom_update
		;;
	k8s)
		k8s_update
		;;
	event)
		event_update
		;;
	auto)
		auto_update
		;;
    pipeline)
        pipeline_update
        ;;
    deploy)
        deploy_update
        ;;
    kbase)
        kbase_update
        ;;
    all)
        prom_update
		k8s_update
		event_update
		auto_update
        pipeline_update
        deploy_update
        kbase_update
        ;;
	help|*)
		echo $"Usage: $0 {[all|kbase|prom|k8s|event|autoï½œpipeline|deploy}"
	        ;;
esac
}

main $1
